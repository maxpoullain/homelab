- name: Lab

  columns:
    - size: small
      widgets:

        - type: monitor
          title: Services
          cache: 10m
          sites:
            - title: Affine
              url: https://docs.corsair.tf/
              check-url: https://docs.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:affine
            - title: Home Assistant
              url: https://home.corsair.tf/
              check-url: https://home.corsair.tf/
              timeout: 5s
              alt-status-codes: [403]
              icon: di:home-assistant
            - title: Dockhand
              url: https://admin.corsair.tf/
              check-url: https://admin.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:docker
            - title: TrueNAS
              url: https://truenas.corsair.tf/
              check-url: https://truenas.corsair.tf/
              timeout: 5s
              alt-status-codes: [403]
              icon: di:truenas
            - title: Beszel
              url: https://status.corsair.tf/
              check-url: https://status.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:beszel
            - title: Traefik
              url: https://traefik.corsair.tf/
              check-url: https://traefik.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:traefik
            - title: AdGuard DNS
              url: https://dns.corsair.tf/
              check-url: https://dns.corsair.tf/
              timeout: 5s
              alt-status-codes: [401, 403]
              icon: di:adguard-home

        - type: monitor
          title: " "
          cache: 10m
          style: compact
          sites:
            - title: VaultWarden
              url: https://vault.corsair.tf/
              check-url: https://vault.corsair.tf/
              timeout: 5s
            - title: Zigbee2MQTT
              url: https://zigbee.corsair.tf/
              check-url: https://zigbee.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
            - title: WAN
              url: https://livebox.corsair.tf/
              check-url: https://livebox.corsair.tf/
              timeout: 5s
              alt-status-codes: [403]

    - size: full
      widgets:

        - type: split-column
          widgets:
            - type: group
              widgets:
                - type: reddit
                  subreddit: selfhosted
                  show-thumbnails: true
                  show-flairs: true
                  extra-sort-by: engagement
                  collapse-after: 8
                - type: rss
                  title: Homelab News
                  style: vertical-list
                  limit: 15
                  collapse-after: 10
                  feeds:
                    - url: https://selfh.st/rss/
                      title: selfh.st

            - type: group
              widgets:
                - type: releases
                  token: ${GITHUB_TOKEN}
                  title: Releases
                  repositories:
                    - glanceapp/glance
                    - immich-app/immich
                    - home-assistant/core
                    - traefik/traefik
                    - crowdsecurity/crowdsec
                    - steveiliop56/tinyauth
                    - dockerhub:fnsys/dockhand
                    - linuxserver/docker-socket-proxy
                    - henrygd/beszel
                    - dockerhub:eclipse-mosquitto/mosquitto
                    - Koenkk/zigbee2mqtt
                    - tailscale/tailscale
                    - AdguardTeam/AdGuardHome
                    - toeverything/AFFiNE
                    - dani-garcia/vaultwarden
                    - OctoPrint/OctoPrint
                  show-source-icon: true
                  limit: 25
                  collapse-after: 15
                  cache: 3h

    - size: small
      widgets:

        - type: clock
          title: " "
          hour-format: 24h

        - type: custom-api
          title: Server Stats
          cache: 5m
          options:
            base-url: ${BESZEL_URL}
            api-key: ${BESZEL_TOKEN}
          template: |
            {{/* Required config options */}}
            {{ $baseURL := .Options.StringOr "base-url" "" }}
            {{ $apiKey := .Options.StringOr "api-key" "" }}
          
            {{/* Error message template */}}
            {{ define "errorMsg" }}
              <div class="widget-error-header">
                <div class="color-negative size-h3">ERROR</div>
                <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                </svg>
              </div>
              <p class="break-all">{{ . }}</p>
            {{ end }}
          
            {{ define "formatGigabytes" }}
              {{ $value := . }}
              {{ $label := "GB" }}
              {{- if lt $value 1.0 }}
                {{ $value = mul $value 1000.0 }}
                {{ $label = "MB" }}
              {{- else if lt $value 1000.0 }}
              {{ else }}
                {{ $value = div $value 1000.0 }}
                {{ $label = "TB" }}
              {{ end }}
              {{ printf "%.1f" $value }} <span class="color-base size-h5">{{ $label }}</span>
            {{ end }}
          
            {{/* Check required fields */}}
            {{ if or (eq $baseURL "") (eq $apiKey "") }}
              {{ template "errorMsg" "Some required options are not set." }}
            {{ else }}
          
              {{ $token := concat "Bearer " $apiKey }}
          
              {{ $systemsResponse := newRequest (print $baseURL "/api/collections/systems/records")
                  | withHeader "Authorization" $token
                  | getResponse }}
              {{ $systems := $systemsResponse.JSON.Array "items" }}
          
          
              {{ range $n, $system := $systems }}
                {{ $status := $system.String "status" }}
          
                {{ $systemStatsRequest := newRequest (print $baseURL "/api/collections/system_stats/records")
                    | withHeader "Authorization" $token
                    | withParameter "sort" "-created"
                    | withParameter "page" "1"
                    | withParameter "perPage" "1"
                    | withParameter "filter" (print "type='1m'&&system='" ($system.String "id") "'")
                    | getResponse }}
          
                {{ $systemStatItems := $systemStatsRequest.JSON.Array "items" }}
          
                {{ $hostname := $system.String "name" }}
                {{ $uptimeSec := $system.Float "info.u" }}
          
                {{ $systemTemp := $system.Float "info.dt"}}
          
                {{ $cpuLoad := $system.Float "info.cpu" }}
                {{ $cpuLoad1m := $system.Float "info.l1" }}
                {{ $cpuLoad15m := $system.Float "info.l15" }}
          
                {{ $memoryUsedPercent := $system.Float "info.mp" }}
          
                {{ $rootUsedPercent := $system.Float "info.dp" }}
          
                {{ $hasStats := false }}
                {{ $systemStats := "" }}
          
                {{ $memoryTotalGb := 0.0 }}
                {{ $memoryUsedGb := 0.0 }}
                {{ $swapTotalGb := 0.0 }} 
                {{ $swapUsedGb := 0.0 }}
                {{ $swapUsedPercent := 0.0 }}
                {{ $rootTotalGb := 0.0 }}
                {{ $rootUsedGb := 0.0 }}
          
                {{ if gt (len $systemStatItems) 0 }}
                  {{ $hasStats = true }}
                  {{ $systemStats = index $systemStatItems 0 }}
          
                  {{ $memoryTotalGb = $systemStats.Float "stats.m" }}
                  {{ $memoryUsedGb = $systemStats.Float "stats.mu" }}
          
                  {{ $swapTotalGb = $systemStats.Float "stats.s" }}
                  {{ $swapUsedGb = $systemStats.Float "stats.su" }}
                  {{ $swapUsedPercent = mul (div $swapUsedGb $swapTotalGb) 100.0 }}
          
                  {{ $rootTotalGb = $systemStats.Float "stats.d" }}
                  {{ $rootUsedGb = $systemStats.Float "stats.du" }}
                {{ end }}
          
                <div class="server">
                  <div class="server-info">
                    <div class="server-details">
                      <div class="server-name color-highlight size-h3">{{ $hostname }}</div>
                      <div>
                        {{ if eq $status "up" }}
                          <span>{{ printf "%.1f" (mul $uptimeSec 0.000011574) }}d</span> uptime
                        {{ else }}
                          unreachable
                        {{ end }}
                      </div>
                    </div>
                    <div class="shrink-0"{{ if eq $status "up" }} data-popover-type="html" data-popover-margin="0.2rem" data-popover-max-width="400px"{{ end }}>
                      {{- if eq $status "up" }}
                      <div data-popover-html>
                        <div class="flex">
                          <div class="size-h5 text-compact">Kernel</div>
                          <div class="value-separator"></div>
                          <div class="color-highlight">{{ $system.String "info.k" }}</div>
                        </div>
                        <div class="flex">
                          <div class="size-h5 text-compact">CPU</div>
                          <div class="value-separator"></div>
                          <div class="color-highlight">{{ $system.String "info.m" }}</div>
                        </div>
                      </div>
                      {{- end }}
                      <svg class="server-icon" stroke="var(--color-{{ if eq $status "up" }}positive{{ else }}negative{{ end }})" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 17.25v-.228a4.5 4.5 0 0 0-.12-1.03l-2.268-9.64a3.375 3.375 0 0 0-3.285-2.602H7.923a3.375 3.375 0 0 0-3.285 2.602l-2.268 9.64a4.5 4.5 0 0 0-.12 1.03v.228m19.5 0a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3m19.5 0a3 3 0 0 0-3-3H5.25a3 3 0 0 0-3 3m16.5 0h.008v.008h-.008v-.008Zm-3 0h.008v.008h-.008v-.008Z" />
                      </svg>
                    </div>
                  </div>
          
                  <div class="server-stats">
                    <div class="flex-1">
                      <div class="flex items-end size-h5">
                        <div>CPU</div>
                        {{- if ge $systemTemp 80.0 }}
                        <svg class="server-spicy-cpu-icon" fill="var(--color-negative)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" >
                          <path fill-rule="evenodd" d="M8.074.945A4.993 4.993 0 0 0 6 5v.032c.004.6.114 1.176.311 1.709.16.428-.204.91-.61.7a5.023 5.023 0 0 1-1.868-1.677c-.202-.304-.648-.363-.848-.058a6 6 0 1 0 8.017-1.901l-.004-.007a4.98 4.98 0 0 1-2.18-2.574c-.116-.31-.477-.472-.744-.28Zm.78 6.178a3.001 3.001 0 1 1-3.473 4.341c-.205-.365.215-.694.62-.59a4.008 4.008 0 0 0 1.873.03c.288-.065.413-.386.321-.666A3.997 3.997 0 0 1 8 8.999c0-.585.126-1.14.351-1.641a.42.42 0 0 1 .503-.235Z" clip-rule="evenodd" />
                        </svg>
                        {{- end }}
                        <div class="color-highlight margin-left-auto text-very-compact">{{ $cpuLoad }} <span class="color-base">%</span></div>
                      </div>
                      <div data-popover-type="html">
                        <div data-popover-html>
                          <div class="flex">
                            <div class="size-h5">1M AVG</div>
                            <div class="value-separator"></div>
                            <div class="color-highlight text-very-compact">{{ printf "%.1f" $cpuLoad1m }} <span class="color-base size-h5">%</span></div>
                          </div>
                          <div class="flex margin-top-3">
                            <div class="size-h5">15M AVG</div>
                            <div class="value-separator"></div>
                            <div class="color-highlight text-very-compact">{{ printf "%.1f" $cpuLoad15m }} <span class="color-base size-h5">%</span></div>
                          </div>
                          <div class="flex margin-top-3">
                            <div class="size-h5">TEMP C</div>
                            <div class="value-separator"></div>
                            <div class="color-highlight text-very-compact">{{ printf "%.1f" $systemTemp }} <span class="color-base size-h5">Â°</span></div>
                          </div>
                        </div>
          
                        <div class="progress-bar progress-bar-combined">
                          <div class="progress-value{{ if ge $cpuLoad1m 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $cpuLoad1m }}"></div>
                          <div class="progress-value{{ if ge $cpuLoad15m 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $cpuLoad15m }}"></div>
                        </div>
                      </div>
                    </div>
          
                    <div class="flex-1">
                      <div class="flex justify-between items-end size-h5">
                        <div>RAM</div>
                        <div class="color-highlight text-very-compact">{{ $memoryUsedPercent }} <span class="color-base">%</span></div>
                      </div>
                      <div data-popover-type="html">
                        {{- if $hasStats }}
                        <div data-popover-html>
                          <div class="flex">
                            <div class="size-h5">RAM</div>
                            <div class="value-separator"></div>
                            <div class="color-highlight text-very-compact">
                              {{ template "formatGigabytes" $memoryUsedGb }} <span class="color-base size-h5">/</span> {{ template "formatGigabytes" $memoryTotalGb }}
                            </div>
                          </div> 
                          {{- if gt $swapTotalGb 0.0 }}
                          <div class="flex margin-top-3">
                            <div class="size-h5">SWAP</div>
                            <div class="value-separator"></div>
                            <div class="color-highlight text-very-compact">
                              {{ template "formatGigabytes" $swapUsedGb }} <span class="color-base size-h5">/</span> {{ template "formatGigabytes" $swapTotalGb }}
                            </div>
                          </div>
                          {{- end }}
                        </div>
                        {{- end }}
                        <div class="progress-bar progress-bar-combined">
                          <div class="progress-value{{ if ge $memoryUsedPercent 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $memoryUsedPercent }}"></div>
                          {{- if gt $swapTotalGb 0.0 }}
                          <div class="progress-value{{ if ge $swapUsedPercent 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $swapUsedPercent }}"></div>
                          {{- end }}
                        </div>
                      </div>
                    </div>
          
                    <div class="flex-1">
                      <div class="flex justify-between items-end size-h5">
                        <div>DISK</div>
                        <div class="color-highlight text-very-compact">{{ $rootUsedPercent }} <span class="color-base">%</span></div>
                      </div>
                      <div data-popover-type="html">
                        {{- if $hasStats }}
                        <div data-popover-html>
                          <ul class="list list-gap-2">
                            <li class="flex">
                              <div class="size-h5">/</div>
                              <div class="value-separator"></div>
                              <div class="color-highlight text-very-compact">
                                {{ template "formatGigabytes" $rootUsedGb }} <span class="color-base size-h5">/</span> {{ template "formatGigabytes" $rootTotalGb }}
                              </div>
                            </li>
                              {{ range $key, $efs := ($systemStats.Get "stats.efs").Map }}
                                <li class="flex">
                                  <div class="size-h5">{{ $key }}</div>
                                  <div class="value-separator"></div>
                                  <div class="color-highlight text-very-compact">
                                    {{ template "formatGigabytes" (($efs.Get "du").Float) }} <span class="color-base size-h5">/</span> {{ template "formatGigabytes" (($efs.Get "d").Float) }}
                                  </div>
                                </li>
                              {{ end }}
                          </ul>
                        </div>
                        {{- end }}
                        <div class="progress-bar progress-bar-combined">
                          <div class="progress-value{{ if ge $rootUsedPercent 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $rootUsedPercent }}"></div>
                          {{ range $key, $efs := ($system.Get "info.efs").Map }}
                            {{ $percent := $efs.Float }}
                            <div class="progress-value{{ if ge $percent 85.0 }} progress-value-notice{{ end }}" style="--percent: {{ $percent }}"></div>
                          {{ end }}
                        </div>
                      </div>
                    </div>
          
                  </div>
                </div>
              {{ end }}
            {{ end }}

        - type: custom-api
          title: TrueNAS Pools
          cache: 1m
          template: |             
            {{
              $dataset := newRequest "${TRUENAS_HOST}/api/v2.0/pool/dataset"
                | withHeader "Authorization" "Bearer ${TRUENAS_API_KEY}"
                | getResponse
            }}
            {{
              $pool := newRequest "${TRUENAS_HOST}/api/v2.0/pool"
                | withHeader "Authorization" "Bearer ${TRUENAS_API_KEY}"
                | getResponse
            }}

            {{ range $dataset.JSON.Array "" }}
              {{ if not (findMatch "/" (.String "name")) }}

                {{ $used := .Float "used.parsed" }}
                {{ $available := .Float "available.parsed" }}
                {{ $total := add $used $available }}

                {{ $totalTb := div (div (div (div $total 1024) 1024) 1024) 1024 | printf "%.1f" }}

                {{ $percent := mul (div $used $total) 100 | printf "%.1f" }}

                {{ $searchString := printf "..#.#(name==\"%s\").healthy|0" (.String "name") }}
                {{ $healthy := $pool.JSON.Bool $searchString }}

                <div style="margin-bottom: 1rem;">
                  <div class="color-highlight size-h3">
                    {{ if $healthy }}
                      <span style="display: inline-block; background-color: var(--color-positive); width: 12px; height: 12px; border-radius: 50%;"></span>
                    {{ else }}
                      <span style="display: inline-block; background-color: var(--color-negative); width: 12px; height: 12px; border-radius: 50%;"></span>
                    {{ end }}
                    <span>{{ .String "name" }}</span>
                  </div>

                  <div class="progress-bar progress-bar-combined" style="position: relative;">
                    <div class="flex justify" style="position: absolute; width: 100%; justify-content: center;">
                      <span>{{ .String "used.value" }} / {{ $totalTb }}T ({{ $percent }}%)</span>
                    </div>
                    <div class="progress-value" style="--percent: {{ $percent }}"></div>
                  </div>
                </div>

              {{ end }}
            {{ end }}

        - type: group
          widgets:

            - type: dns-stats
              title: DNS Stats
              service: adguard
              url: http://172.17.0.1:3000
              hide-graph: false
              hour-format: 24h

            - type: custom-api
              title: Tailscale
              title-url: https://login.tailscale.com/admin/machines
              url: https://api.tailscale.com/api/v2/tailnet/-/devices
              headers:
                Authorization: Bearer ${TAILSCALE_API_KEY}
              cache: 10m
              options:
                collapseAfter: 8
                disableOfflineIndicator: false
                disableUpdateIndicator: true
                prioritiseTags: false
              template: |
                <style>
                  .device-info-container-tailscale {
                    position: relative;
                    overflow: hidden;
                    height: 1.5em;
                  }

                  .device-info-tailscale {
                    display: flex;
                    transition: transform 0.2s ease, opacity 0.2s ease;
                  }

                  .device-ip-tailscale {
                    position: absolute;
                    top: 0;
                    left: 0;
                    transform: translateY(-100%);
                    opacity: 0;
                    transition: transform 0.2s ease, opacity 0.2s ease;
                  }

                  .device-info-container-tailscale:hover .device-info-tailscale {
                    transform: translateY(100%);
                    opacity: 0;
                  }

                  .device-info-container-tailscale:hover .device-ip-tailscale {
                    transform: translateY(0);
                    opacity: 1;
                  }

                  .update-indicator-tailscale {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background-color: var(--color-primary);
                    display: inline-block;
                    margin-left: 4px;
                    vertical-align: middle;
                  }

                  .offline-indicator-tailscale {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background-color: var(--color-negative);
                    display: inline-block;
                    margin-left: 4px;
                    vertical-align: middle;
                  }

                  .device-name-container-tailscale {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  }

                  .indicators-container-tailscale {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                  }
                </style>
                <ul class="list list-gap-10 collapsible-container" data-collapse-after="{{ .Options.IntOr "collapseAfter" 3 }}">
                  {{ range .JSON.Array "devices" }}
                  <li>
                    <div class="flex items-center gap-10">
                      <div class="device-name-container-tailscale grow">
                        <span class="size-h4 block text-truncate color-primary">
                          {{ findMatch "^([^.]+)" (.String "name") }}
                        </span>
                        <div class="indicators-container-tailscale">
                          {{ if and (not ($.Options.BoolOr "disableUpdateIndicator" false)) (.Bool "updateAvailable") }}
                          <span class="update-indicator-tailscale" data-popover-type="text" data-popover-text="Update Available"></span>
                          {{ end }}

                          {{ if not ($.Options.BoolOr "disableOfflineIndicator" false) }}
                          {{ $lastSeen := .String "lastSeen" | parseTime "rfc3339" }}
                          {{ if not ($lastSeen.After (offsetNow "-10s")) }}
                          {{ $lastSeenTimezoned := $lastSeen.In now.Location }}
                          <span class="offline-indicator-tailscale" data-popover-type="text"
                            data-popover-text="Offline - Last seen {{ $lastSeenTimezoned.Format " Jan 2 3:04pm" }}"></span>
                          {{ end }}
                          {{ end }}

                        </div>
                      </div>
                    </div>
                    <div class="device-info-container-tailscale">
                      <ul class="list-horizontal-text device-info-tailscale">
                        <li>{{ .String "os" }}</li>
                        <li>
                          {{ if and ($.Options.BoolOr "prioritiseTags" false) (.Exists "tags.0") }}
                            {{ trimPrefix "tag:" (.String "tags.0") }}
                          {{ else }}
                            {{ .String "user" }}
                          {{ end }}
                        </li>
                      </ul>
                      <div class="device-ip-tailscale">
                        {{ .String "addresses.0"}}
                      </div>
                    </div>
                  </li>
                  {{ end }}
                </ul>
- name: Media
  head-widgets:
      - type: group
        widgets:
          - type: custom-api
            title: NextUp
            frameless: true
            cache: 5m
            options:
              base-url: ${JELLYFIN_URL}
              api-key: ${JELLYFIN_API_KEY}
              user-name: "Max"
              library-name: "Shows"
              mode: "nextup"
              item-count: "8"
              small-column: false
              show-thumbnail: true
              thumbnail-aspect-ratio: "default"
            template: |
              {{/* Required config options */}}
              {{ $baseURL := .Options.StringOr "base-url" "" }}
              {{ $apiKey := .Options.StringOr "api-key" "" }}
              {{ $userName := .Options.StringOr "user-name" "" }}

              {{/* Required config options for "latest" mode */}}
              {{ $libraryName := .Options.StringOr "library-name" "" }}

              {{/* Optional config options */}}
              {{ $mode := .Options.StringOr "mode" "latest" }}
              {{ $itemCount := .Options.StringOr "item-count" "10" }}
              {{ $mediaTypes := .Options.StringOr "media-types" "Movie,Episode,MusicAlbum" }}
              {{ $thumbAspectRatio := .Options.StringOr "thumbnail-aspect-ratio" "" }}
              {{ $isSmallColumn:= .Options.BoolOr "small-column" false }}
              {{ $showThumbnail := .Options.BoolOr "show-thumbnail" false }}
              {{ $showProgressBar := .Options.BoolOr "progress-bar" true }}

              {{/* Error message template */}}
              {{ define "errorMsg" }}
                <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">{{ . }}</p>
              {{ end }}

              {{/* Check required fields */}}
              {{ if or (eq $baseURL "") (eq $apiKey "") (eq $userName "") (eq $mode "") (and (eq $mode "latest") (eq $libraryName "")) }}
                {{ template "errorMsg" "Some required options are not set." }}
              {{ else }}

                {{/* Fetch user ID */}}
                {{ $userID := "" }}
                {{ $usersCall := newRequest (print $baseURL "/Users")
                    | withParameter "api_key" $apiKey
                    | withHeader "Accept" "application/json"
                    | getResponse }}

                {{ range $i, $user := $usersCall.JSON.Array "" }}
                  {{ if eq ($user.String "Name") $userName }}
                    {{ $userID = $user.String "Id" }}
                    {{ break }}
                  {{ end }}
                {{ end }}
                {{ if eq $userID "" }}
                  {{ template "errorMsg" (printf "User '%s' not found." $userName) }}
                {{ else }}

                  {{ $items := "" }}

                  {{ if eq $mode "latest" }}

                    {{/* Fetch library ID */}}
                    {{ $libraryID := "" }}
                    {{ $userViewsCall := newRequest (print $baseURL "/UserViews")
                        | withParameter "api_key" $apiKey
                        | withParameter "userId" $userID
                        | withHeader "Accept" "application/json"
                        | getResponse }}

                    {{ range $i, $item := $userViewsCall.JSON.Array "Items" }}
                      {{ if eq ($item.String "Name") $libraryName }}
                        {{ $libraryID = $item.String "Id" }}
                        {{ break }}
                      {{ end }}
                    {{ end }}

                    {{ if eq $libraryID "" }}
                      {{ template "errorMsg" (printf "Library '%s' not found." $libraryName) }}
                    {{ else }}
                      {{/* Fetch latest items */}}
                      {{ $latestCall := newRequest (print $baseURL "/Users/" $userID "/Items/Latest")
                          | withParameter "api_key" $apiKey
                          | withParameter "Limit" $itemCount
                          | withParameter "ParentId" $libraryID
                          | withParameter "IncludeItemTypes" $mediaTypes
                          | withParameter "GroupItems" "true"
                          | withHeader "Accept" "application/json"
                          | getResponse }}
                      {{ $items = $latestCall.JSON.Array "" }}
                    {{ end }}

                  {{ else if eq $mode "nextup" }}

                    {{/* Fetch next up items */}}
                    {{ $nextUpCall := newRequest (print $baseURL "/Shows/NextUp")
                      | withParameter "api_key" $apiKey
                      | withParameter "UserId" $userID
                      | withParameter "Limit" $itemCount
                      | withParameter "EnableResumable" "true"
                      | withHeader "Accept" "application/json"
                      | getResponse }}
                    {{ $items = $nextUpCall.JSON.Array "Items" }}

                  {{ else }}
                    {{ template "errorMsg" "Unknown mode, expected 'latest' or 'nextup'" }}
                  {{ end }}

                  {{ if eq (len $items) 0 }}
                    <p>No items found, start streaming something!</p>
                  {{ else }}

                    {{/* Display the item carousel */}}
                    <div class="carousel-container show-right-cutoff">
                      <div class="cards-horizontal carousel-items-container">
                        {{ range $n, $item := $items }}
                          {{/* Common item variables */}}
                          {{ $mediaType := $item.String "Type" }}
                          {{ $title := $item.String "Name" }}
                          {{ $itemID := $item.String "Id" }}

                          {{/* Media type specific variables */}}
                          {{ $seriesTitle := "" }}
                          {{ $artist := "" }}
                          {{ $seriesID := "" }}
                          {{ $season := "" }}
                          {{ $episode := "" }}
                          {{ $playPercentage := "" }}
                          {{ $unwatchedEpisodeCount := "" }}

                          {{ if eq $mediaType "Movie" }}
                          {{ else if eq $mediaType "Series" }}
                            {{ $unwatchedEpisodeCount = $item.Int "UserData.UnplayedItemCount" }}
                          {{ else if eq $mediaType "Episode" }}
                            {{ $unwatchedEpisodeCount = 1 }}
                            {{ $seriesTitle = $item.String "SeriesName" }}
                            {{ $seriesID = $item.String "SeriesId" }}
                            {{ $season = $item.Int "ParentIndexNumber" }}
                            {{ $episode = $item.Int "IndexNumber" }}

                            {{ if $item.Exists "UserData.PlayedPercentage" }}
                              {{ $playPercentage = $item.String "UserData.PlayedPercentage" }}
                            {{ end }}

                            {{/* For latest always refer to the series not individual episodes */}}
                            {{ if eq $mode "latest" }}
                              {{ $itemID = $seriesID }}
                              {{ $title = $seriesTitle }}
                            {{ end }}
                          {{ else if eq $mediaType "MusicAlbum" }}
                            {{ $artist = $item.String "AlbumArtist" }}
                          {{ end }}

                          {{ $linkURL := print $baseURL "/web/#/details?id=" $itemID }}
                          {{ $thumbURL := "" }}
                          {{ if not (eq $playPercentage "") }}
                            {{/* $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey "&percentPlayed=" $playPercentage */}}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ else }}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ end }}

                          <a class="card widget-content-frame" href="{{ $linkURL | safeURL }}" style="width: 7vw; min-width: 7vw; flex-shrink: 0;">
                            {{ if $showThumbnail }}
                              <div style="position: relative;">
                                <img src="{{ $thumbURL | safeURL }}"
                                  alt="{{ $title }} thumbnail"
                                  loading="lazy"
                                  class="media-server-thumbnail shrink-0"
                                  style="
                                    object-fit: fill;
                                    border-radius: var(--border-radius) var(--border-radius) 0 0;
                                    width: 100%;
                                    display: block;
                                    {{ if eq $thumbAspectRatio "square" }}aspect-ratio: 1;
                                    {{ else if eq $thumbAspectRatio "portrait" }}aspect-ratio: 2/3;
                                    {{ else if eq $thumbAspectRatio "landscape" }}aspect-ratio: 16/9;
                                    {{ else }}aspect-ratio: initial;
                                    {{ end }}
                                  "
                                />

                                {{ if and ($showProgressBar) (not (eq $playPercentage "")) }}
                                  <div style="
                                    position: absolute;
                                    bottom: 8px;
                                    left: 8px;
                                    right: 8px;
                                    height: 6px;
                                    border-radius: var(--border-radius);
                                    overflow: hidden;
                                    background-color: rgba(255, 255, 255, 0.2);
                                  ">
                                    <div style="
                                      width: {{ print $playPercentage "%" }};
                                      height: 100%;
                                      border-radius: var(--border-radius) 0 0 var(--border-radius);
                                      background-color: var(--color-primary)
                                    "></div>
                                  </div>
                                {{ end }}
                              </div>
                            {{ end }}

                            <div class="grow padding-inline-widget margin-top-10 margin-bottom-10">
                              <ul class="flex flex-column justify-evenly margin-bottom-3 {{ if $isSmallColumn }}size-h6{{ end }}" style="height: 100%;">
                                {{ if eq $mode "latest" }}
                                  {{ if or (eq $mediaType "Series") (eq $mediaType "Episode") }}
                                    <li class="text-truncate" title="{{ $title }}">{{ $title }}</li>
                                  {{ else if eq $mediaType "MusicAlbum" }}
                                    <ul class="list-horizontal-text flex-nowrap">
                                      <li class="color-primary text-truncate">{{ $artist }}</li>
                                      <li class="text-truncate">{{ $title }}</li>
                                    </ul>
                                  {{ else }}
                                    <li class="text-truncate">{{ $title }}</li>
                                  {{ end }}
                                {{ else if eq $mode "nextup" }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary shrink-0">S{{ $season }}E{{ $episode }}</li>
                                    <li class="text-truncate">{{ $seriesTitle }}</li>
                                  </ul>
                                  <li class="text-truncate">{{ $title }}</li>
                                {{ end }}
                              </ul>
                            </div>
                          </a>
                        {{ end }}
                      </div>
                    </div>
                  {{ end }}

                {{ end }}

              {{ end }}

          - type: custom-api
            title: Latest Shows
            frameless: true
            cache: 5m
            options:
              base-url: ${JELLYFIN_URL}
              api-key: ${JELLYFIN_API_KEY}
              user-name: "Max"
              library-name: "Shows"
              mode: "latest"
              item-count: "11"
              small-column: true
              show-thumbnail: true
              thumbnail-aspect-ratio: "portrait"
            template: |
              {{/* Required config options */}}
              {{ $baseURL := .Options.StringOr "base-url" "" }}
              {{ $apiKey := .Options.StringOr "api-key" "" }}
              {{ $userName := .Options.StringOr "user-name" "" }}

              {{/* Required config options for "latest" mode */}}
              {{ $libraryName := .Options.StringOr "library-name" "" }}

              {{/* Optional config options */}}
              {{ $mode := .Options.StringOr "mode" "latest" }}
              {{ $itemCount := .Options.StringOr "item-count" "10" }}
              {{ $mediaTypes := .Options.StringOr "media-types" "Movie,Episode,MusicAlbum" }}
              {{ $thumbAspectRatio := .Options.StringOr "thumbnail-aspect-ratio" "" }}
              {{ $isSmallColumn:= .Options.BoolOr "small-column" false }}
              {{ $showThumbnail := .Options.BoolOr "show-thumbnail" false }}
              {{ $showProgressBar := .Options.BoolOr "progress-bar" true }}

              {{/* Error message template */}}
              {{ define "errorMsg" }}
                <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">{{ . }}</p>
              {{ end }}

              {{/* Check required fields */}}
              {{ if or (eq $baseURL "") (eq $apiKey "") (eq $userName "") (eq $mode "") (and (eq $mode "latest") (eq $libraryName "")) }}
                {{ template "errorMsg" "Some required options are not set." }}
              {{ else }}

                {{/* Fetch user ID */}}
                {{ $userID := "" }}
                {{ $usersCall := newRequest (print $baseURL "/Users")
                    | withParameter "api_key" $apiKey
                    | withHeader "Accept" "application/json"
                    | getResponse }}

                {{ range $i, $user := $usersCall.JSON.Array "" }}
                  {{ if eq ($user.String "Name") $userName }}
                    {{ $userID = $user.String "Id" }}
                    {{ break }}
                  {{ end }}
                {{ end }}
                {{ if eq $userID "" }}
                  {{ template "errorMsg" (printf "User '%s' not found." $userName) }}
                {{ else }}

                  {{ $items := "" }}

                  {{ if eq $mode "latest" }}

                    {{/* Fetch library ID */}}
                    {{ $libraryID := "" }}
                    {{ $userViewsCall := newRequest (print $baseURL "/UserViews")
                        | withParameter "api_key" $apiKey
                        | withParameter "userId" $userID
                        | withHeader "Accept" "application/json"
                        | getResponse }}

                    {{ range $i, $item := $userViewsCall.JSON.Array "Items" }}
                      {{ if eq ($item.String "Name") $libraryName }}
                        {{ $libraryID = $item.String "Id" }}
                        {{ break }}
                      {{ end }}
                    {{ end }}

                    {{ if eq $libraryID "" }}
                      {{ template "errorMsg" (printf "Library '%s' not found." $libraryName) }}
                    {{ else }}
                      {{/* Fetch latest items */}}
                      {{ $latestCall := newRequest (print $baseURL "/Users/" $userID "/Items/Latest")
                          | withParameter "api_key" $apiKey
                          | withParameter "Limit" $itemCount
                          | withParameter "ParentId" $libraryID
                          | withParameter "IncludeItemTypes" $mediaTypes
                          | withParameter "GroupItems" "true"
                          | withHeader "Accept" "application/json"
                          | getResponse }}
                      {{ $items = $latestCall.JSON.Array "" }}
                    {{ end }}

                  {{ else if eq $mode "nextup" }}

                    {{/* Fetch next up items */}}
                    {{ $nextUpCall := newRequest (print $baseURL "/Shows/NextUp")
                      | withParameter "api_key" $apiKey
                      | withParameter "UserId" $userID
                      | withParameter "Limit" $itemCount
                      | withParameter "EnableResumable" "true"
                      | withHeader "Accept" "application/json"
                      | getResponse }}
                    {{ $items = $nextUpCall.JSON.Array "Items" }}

                  {{ else }}
                    {{ template "errorMsg" "Unknown mode, expected 'latest' or 'nextup'" }}
                  {{ end }}

                  {{ if eq (len $items) 0 }}
                    <p>No items found, start streaming something!</p>
                  {{ else }}

                    {{/* Display the item carousel */}}
                    <div class="carousel-container show-right-cutoff">
                      <div class="cards-horizontal carousel-items-container">
                        {{ range $n, $item := $items }}
                          {{/* Common item variables */}}
                          {{ $mediaType := $item.String "Type" }}
                          {{ $title := $item.String "Name" }}
                          {{ $itemID := $item.String "Id" }}

                          {{/* Media type specific variables */}}
                          {{ $seriesTitle := "" }}
                          {{ $artist := "" }}
                          {{ $seriesID := "" }}
                          {{ $season := "" }}
                          {{ $episode := "" }}
                          {{ $playPercentage := "" }}
                          {{ $unwatchedEpisodeCount := "" }}

                          {{ if eq $mediaType "Movie" }}
                          {{ else if eq $mediaType "Series" }}
                            {{ $unwatchedEpisodeCount = $item.Int "UserData.UnplayedItemCount" }}
                          {{ else if eq $mediaType "Episode" }}
                            {{ $unwatchedEpisodeCount = 1 }}
                            {{ $seriesTitle = $item.String "SeriesName" }}
                            {{ $seriesID = $item.String "SeriesId" }}
                            {{ $season = $item.Int "ParentIndexNumber" }}
                            {{ $episode = $item.Int "IndexNumber" }}

                            {{ if $item.Exists "UserData.PlayedPercentage" }}
                              {{ $playPercentage = $item.String "UserData.PlayedPercentage" }}
                            {{ end }}

                            {{/* For latest always refer to the series not individual episodes */}}
                            {{ if eq $mode "latest" }}
                              {{ $itemID = $seriesID }}
                              {{ $title = $seriesTitle }}
                            {{ end }}
                          {{ else if eq $mediaType "MusicAlbum" }}
                            {{ $artist = $item.String "AlbumArtist" }}
                          {{ end }}

                          {{ $linkURL := print $baseURL "/web/#/details?id=" $itemID }}
                          {{ $thumbURL := "" }}
                          {{ if not (eq $playPercentage "") }}
                            {{/* $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey "&percentPlayed=" $playPercentage */}}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ else }}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ end }}

                          <a class="card widget-content-frame" href="{{ $linkURL | safeURL }}" style="width: 5vw; min-width: 5vw; flex-shrink: 0;">
                            {{ if $showThumbnail }}
                              <div style="position: relative;">
                                <img src="{{ $thumbURL | safeURL }}"
                                  alt="{{ $title }} thumbnail"
                                  loading="lazy"
                                  class="media-server-thumbnail shrink-0"
                                  style="
                                    object-fit: fill;
                                    border-radius: var(--border-radius) var(--border-radius) 0 0;
                                    width: 100%;
                                    display: block;
                                    {{ if eq $thumbAspectRatio "square" }}aspect-ratio: 1;
                                    {{ else if eq $thumbAspectRatio "portrait" }}aspect-ratio: 2/3;
                                    {{ else if eq $thumbAspectRatio "landscape" }}aspect-ratio: 16/9;
                                    {{ else }}aspect-ratio: initial;
                                    {{ end }}
                                  "
                                />

                                {{ if and ($showProgressBar) (not (eq $playPercentage "")) }}
                                  <div style="
                                    position: absolute;
                                    bottom: 8px;
                                    left: 8px;
                                    right: 8px;
                                    height: 6px;
                                    border-radius: var(--border-radius);
                                    overflow: hidden;
                                    background-color: rgba(255, 255, 255, 0.2);
                                  ">
                                    <div style="
                                      width: {{ print $playPercentage "%" }};
                                      height: 100%;
                                      border-radius: var(--border-radius) 0 0 var(--border-radius);
                                      background-color: var(--color-primary)
                                    "></div>
                                  </div>
                                {{ end }}
                              </div>
                            {{ end }}

                            <div class="grow padding-inline-widget margin-top-10 margin-bottom-10">
                              <ul class="flex flex-column justify-evenly margin-bottom-3 {{ if $isSmallColumn }}size-h6{{ end }}" style="height: 100%;">
                                {{ if eq $mode "latest" }}
                                  {{ if or (eq $mediaType "Series") (eq $mediaType "Episode") }}
                                    <li class="text-truncate" title="{{ $title }}">{{ $title }}</li>
                                  {{ else if eq $mediaType "MusicAlbum" }}
                                    <ul class="list-horizontal-text flex-nowrap">
                                      <li class="color-primary text-truncate">{{ $artist }}</li>
                                      <li class="text-truncate">{{ $title }}</li>
                                    </ul>
                                  {{ else }}
                                    <li class="text-truncate">{{ $title }}</li>
                                  {{ end }}
                                {{ else if eq $mode "nextup" }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary shrink-0">S{{ $season }}E{{ $episode }}</li>
                                    <li class="text-truncate">{{ $seriesTitle }}</li>
                                  </ul>
                                  <li class="text-truncate">{{ $title }}</li>
                                {{ end }}
                              </ul>
                            </div>
                          </a>
                        {{ end }}
                      </div>
                    </div>
                  {{ end }}

                {{ end }}

              {{ end }}

          - type: custom-api
            title: Latest Movies
            frameless: true
            cache: 5m
            options:
              base-url: ${JELLYFIN_URL}
              api-key: ${JELLYFIN_API_KEY}
              user-name: "Max"
              library-name: "Movies"
              mode: "latest"
              item-count: "11"
              small-column: true
              show-thumbnail: true
              thumbnail-aspect-ratio: "portrait"
            template: |
              {{/* Required config options */}}
              {{ $baseURL := .Options.StringOr "base-url" "" }}
              {{ $apiKey := .Options.StringOr "api-key" "" }}
              {{ $userName := .Options.StringOr "user-name" "" }}

              {{/* Required config options for "latest" mode */}}
              {{ $libraryName := .Options.StringOr "library-name" "" }}

              {{/* Optional config options */}}
              {{ $mode := .Options.StringOr "mode" "latest" }}
              {{ $itemCount := .Options.StringOr "item-count" "10" }}
              {{ $mediaTypes := .Options.StringOr "media-types" "Movie,Episode,MusicAlbum" }}
              {{ $thumbAspectRatio := .Options.StringOr "thumbnail-aspect-ratio" "" }}
              {{ $isSmallColumn:= .Options.BoolOr "small-column" false }}
              {{ $showThumbnail := .Options.BoolOr "show-thumbnail" false }}
              {{ $showProgressBar := .Options.BoolOr "progress-bar" true }}

              {{/* Error message template */}}
              {{ define "errorMsg" }}
                <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">{{ . }}</p>
              {{ end }}

              {{/* Check required fields */}}
              {{ if or (eq $baseURL "") (eq $apiKey "") (eq $userName "") (eq $mode "") (and (eq $mode "latest") (eq $libraryName "")) }}
                {{ template "errorMsg" "Some required options are not set." }}
              {{ else }}

                {{/* Fetch user ID */}}
                {{ $userID := "" }}
                {{ $usersCall := newRequest (print $baseURL "/Users")
                    | withParameter "api_key" $apiKey
                    | withHeader "Accept" "application/json"
                    | getResponse }}

                {{ range $i, $user := $usersCall.JSON.Array "" }}
                  {{ if eq ($user.String "Name") $userName }}
                    {{ $userID = $user.String "Id" }}
                    {{ break }}
                  {{ end }}
                {{ end }}
                {{ if eq $userID "" }}
                  {{ template "errorMsg" (printf "User '%s' not found." $userName) }}
                {{ else }}

                  {{ $items := "" }}

                  {{ if eq $mode "latest" }}

                    {{/* Fetch library ID */}}
                    {{ $libraryID := "" }}
                    {{ $userViewsCall := newRequest (print $baseURL "/UserViews")
                        | withParameter "api_key" $apiKey
                        | withParameter "userId" $userID
                        | withHeader "Accept" "application/json"
                        | getResponse }}

                    {{ range $i, $item := $userViewsCall.JSON.Array "Items" }}
                      {{ if eq ($item.String "Name") $libraryName }}
                        {{ $libraryID = $item.String "Id" }}
                        {{ break }}
                      {{ end }}
                    {{ end }}

                    {{ if eq $libraryID "" }}
                      {{ template "errorMsg" (printf "Library '%s' not found." $libraryName) }}
                    {{ else }}
                      {{/* Fetch latest items */}}
                      {{ $latestCall := newRequest (print $baseURL "/Users/" $userID "/Items/Latest")
                          | withParameter "api_key" $apiKey
                          | withParameter "Limit" $itemCount
                          | withParameter "ParentId" $libraryID
                          | withParameter "IncludeItemTypes" $mediaTypes
                          | withParameter "GroupItems" "true"
                          | withHeader "Accept" "application/json"
                          | getResponse }}
                      {{ $items = $latestCall.JSON.Array "" }}
                    {{ end }}

                  {{ else if eq $mode "nextup" }}

                    {{/* Fetch next up items */}}
                    {{ $nextUpCall := newRequest (print $baseURL "/Shows/NextUp")
                      | withParameter "api_key" $apiKey
                      | withParameter "UserId" $userID
                      | withParameter "Limit" $itemCount
                      | withParameter "EnableResumable" "true"
                      | withHeader "Accept" "application/json"
                      | getResponse }}
                    {{ $items = $nextUpCall.JSON.Array "Items" }}

                  {{ else }}
                    {{ template "errorMsg" "Unknown mode, expected 'latest' or 'nextup'" }}
                  {{ end }}

                  {{ if eq (len $items) 0 }}
                    <p>No items found, start streaming something!</p>
                  {{ else }}

                    {{/* Display the item carousel */}}
                    <div class="carousel-container show-right-cutoff">
                      <div class="cards-horizontal carousel-items-container">
                        {{ range $n, $item := $items }}
                          {{/* Common item variables */}}
                          {{ $mediaType := $item.String "Type" }}
                          {{ $title := $item.String "Name" }}
                          {{ $itemID := $item.String "Id" }}

                          {{/* Media type specific variables */}}
                          {{ $seriesTitle := "" }}
                          {{ $artist := "" }}
                          {{ $seriesID := "" }}
                          {{ $season := "" }}
                          {{ $episode := "" }}
                          {{ $playPercentage := "" }}
                          {{ $unwatchedEpisodeCount := "" }}

                          {{ if eq $mediaType "Movie" }}
                          {{ else if eq $mediaType "Series" }}
                            {{ $unwatchedEpisodeCount = $item.Int "UserData.UnplayedItemCount" }}
                          {{ else if eq $mediaType "Episode" }}
                            {{ $unwatchedEpisodeCount = 1 }}
                            {{ $seriesTitle = $item.String "SeriesName" }}
                            {{ $seriesID = $item.String "SeriesId" }}
                            {{ $season = $item.Int "ParentIndexNumber" }}
                            {{ $episode = $item.Int "IndexNumber" }}

                            {{ if $item.Exists "UserData.PlayedPercentage" }}
                              {{ $playPercentage = $item.String "UserData.PlayedPercentage" }}
                            {{ end }}

                            {{/* For latest always refer to the series not individual episodes */}}
                            {{ if eq $mode "latest" }}
                              {{ $itemID = $seriesID }}
                              {{ $title = $seriesTitle }}
                            {{ end }}
                          {{ else if eq $mediaType "MusicAlbum" }}
                            {{ $artist = $item.String "AlbumArtist" }}
                          {{ end }}

                          {{ $linkURL := print $baseURL "/web/#/details?id=" $itemID }}
                          {{ $thumbURL := "" }}
                          {{ if not (eq $playPercentage "") }}
                            {{/* $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey "&percentPlayed=" $playPercentage */}}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ else }}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ end }}

                          <a class="card widget-content-frame" href="{{ $linkURL | safeURL }}" style="width: 5vw; min-width: 5vw; flex-shrink: 0;">
                            {{ if $showThumbnail }}
                              <div style="position: relative;">
                                <img src="{{ $thumbURL | safeURL }}"
                                  alt="{{ $title }} thumbnail"
                                  loading="lazy"
                                  class="media-server-thumbnail shrink-0"
                                  style="
                                    object-fit: fill;
                                    border-radius: var(--border-radius) var(--border-radius) 0 0;
                                    width: 100%;
                                    display: block;
                                    {{ if eq $thumbAspectRatio "square" }}aspect-ratio: 1;
                                    {{ else if eq $thumbAspectRatio "portrait" }}aspect-ratio: 2/3;
                                    {{ else if eq $thumbAspectRatio "landscape" }}aspect-ratio: 16/9;
                                    {{ else }}aspect-ratio: initial;
                                    {{ end }}
                                  "
                                />

                                {{ if and ($showProgressBar) (not (eq $playPercentage "")) }}
                                  <div style="
                                    position: absolute;
                                    bottom: 8px;
                                    left: 8px;
                                    right: 8px;
                                    height: 6px;
                                    border-radius: var(--border-radius);
                                    overflow: hidden;
                                    background-color: rgba(255, 255, 255, 0.2);
                                  ">
                                    <div style="
                                      width: {{ print $playPercentage "%" }};
                                      height: 100%;
                                      border-radius: var(--border-radius) 0 0 var(--border-radius);
                                      background-color: var(--color-primary)
                                    "></div>
                                  </div>
                                {{ end }}
                              </div>
                            {{ end }}

                            <div class="grow padding-inline-widget margin-top-10 margin-bottom-10">
                              <ul class="flex flex-column justify-evenly margin-bottom-3 {{ if $isSmallColumn }}size-h6{{ end }}" style="height: 100%;">
                                {{ if eq $mode "latest" }}
                                  {{ if or (eq $mediaType "Series") (eq $mediaType "Episode") }}
                                    <li class="text-truncate" title="{{ $title }}">{{ $title }}</li>
                                  {{ else if eq $mediaType "MusicAlbum" }}
                                    <ul class="list-horizontal-text flex-nowrap">
                                      <li class="color-primary text-truncate">{{ $artist }}</li>
                                      <li class="text-truncate">{{ $title }}</li>
                                    </ul>
                                  {{ else }}
                                    <li class="text-truncate">{{ $title }}</li>
                                  {{ end }}
                                {{ else if eq $mode "nextup" }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary shrink-0">S{{ $season }}E{{ $episode }}</li>
                                    <li class="text-truncate">{{ $seriesTitle }}</li>
                                  </ul>
                                  <li class="text-truncate">{{ $title }}</li>
                                {{ end }}
                              </ul>
                            </div>
                          </a>
                        {{ end }}
                      </div>
                    </div>
                  {{ end }}

                {{ end }}

              {{ end }}

  columns:
    - size: small
      widgets:
        - type: monitor
          title: Media Services
          cache: 1m
          sites:
            - title: Jellyfin
              url: https://tv.corsair.tf/
              check-url: https://tv.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:jellyfin
            - title: Immich
              url: https://photos.corsair.tf/
              check-url: https://photos.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:immich

        - type: monitor
          title: 7Seas
          cache: 1m
          sites:
            - title: Sonarr
              url: https://shows.corsair.tf/
              check-url: https://shows.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:sonarr
            - title: Radarr
              url: https://movies.corsair.tf/
              check-url: https://movies.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:radarr
            - title: Readarr
              url: https://books.corsair.tf/
              check-url: https://books.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:readarr
            - title: Prowlarr
              url: https://prowlarr.corsair.tf/
              check-url: https://prowlarr.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:prowlarr
            - title: Transmission
              url: https://seedbox.corsair.tf/
              check-url: https://seedbox.corsair.tf/
              timeout: 5s
              alt-status-codes: [401,403]
              icon: di:transmission

    - size: full
      widgets:
        - type: split-column
          widgets:
            - type: videos
              title: YouTube
              channels:
                - UCXuqSBlHAE6Xw-yeJA0Tunw
                - UCR-DXc1voovS8nhAvccRZhg
              limit: 8
              collapse-after: 4
              style: vertical-list
            - type: twitch-channels
              title: Twitch Streams
              channels:
                - domingo
                - jirayalecochon
                - ponce
                - humility
              collapse-after: 5

        - type: split-column
          widgets:
            - type: custom-api
              title: TV Releases
              title-url: ${SONARR_URL}
              cache: 30m
              options:
                service: sonarr          # sonarr, radarr, or lidarr
                type: upcoming           # upcoming, recent, or missing
                size: small             # small, medium, large, or huge
                collapse-after: 2
                show-grabbed: false
                interval: 60             # optional, days
                sort-time: asc          # optional, asc or desc (default)
                #cover-proxy: "https://proxy.example.com/radarrcover" # optional
                api-base-url: ${SONARR_URL}
                key: ${SONARR_API_KEY}
              template: |
                {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}
                {{ $showGrabbed := .Options.BoolOr "show-grabbed" false }}
                {{ $sortTime := .Options.StringOr "sort-time" "desc" }}
                {{ $coverProxy := .Options.StringOr "cover-proxy" "" }}
                {{ $size := .Options.StringOr "size" "medium" }}
                {{ $service := .Options.StringOr "service" "" }}
                {{ $type := .Options.StringOr "type" "" }}
                {{ $intervalH := .Options.IntOr "interval" 0 | mul 24 }}

                {{ $now := now | formatTime "2006-01-02T15:04:05" }}
                {{ $posInterval := (offsetNow (printf "+%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}
                {{ $negInterval := (offsetNow (printf "-%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}

                {{ $apiBaseUrl := .Options.StringOr "api-base-url" "" }}
                {{ $key := .Options.StringOr "key" "" }}
                {{ $url := .Options.StringOr "url" $apiBaseUrl }}

                {{ if or (and (ne $service "sonarr") (ne $service "radarr") (ne $service "lidarr"))
                        (and (ne $type "upcoming") (ne $type "recent") (ne $type "missing")) 
                        (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
                  <div class="widget-error-header">
                      <div class="color-negative size-h3">ERROR</div>
                      <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                      </svg>
                    </div>
                    <p class="break-all">
                      Some options are not set or malformed
                        <table style="border-spacing: 1rem;">
                          <tr><td>service</td><td>{{ $service }}</td><td>must be sonarr, radarr, or lidarr</td></tr>
                          <tr><td>type</td><td>{{ $type }}</td><td>must be upcoming, recent, or missing</td></tr>
                          <tr><td>api-base-url</td><td>{{ $apiBaseUrl }}</td><td>should include http(s):// and port if needed</td></tr>
                          <tr><td>key</td><td>{{ $key }}</td><td></td></tr>
                        </table> 
                    </p>
                {{ else }}
                  {{ $requestUrl := "" }}
              
                  {{ if eq $service "sonarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v3/history/since?includeSeries=true&includeEpisode=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50&includeSeries=true" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v3/calendar?includeSeries=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                    
                  {{ else if eq $service "radarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v3/history/since?includeMovie=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v3/calendar?start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                    
                  {{ else if eq $service "lidarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v1/history/since?includeArtist=true&includeAlbum=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v1/wanted/missing?page=1&pageSize=50&includeArtist=true" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v1/calendar?includeArtist=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                  {{ end }}
              
                  {{ $data := newRequest $requestUrl
                    | withHeader "Accept" "application/json"
                    | withHeader "X-Api-Key" $key
                    | getResponse }}
              
                  <ul class="list list-gap-14 collapsible-container single-line-titles" data-collapse-after="{{ $collapseAfter }}">
                    {{ $array := "" }}
                    {{ $sortByField := "" }}
                    {{ $itemDisplayed := false }}
                    {{ $itemDate := "" }}
                    {{ $isAvailable := false }}
              
                    {{ if eq $type "missing" }}
                      {{ $array = "records" }}
                      {{ if eq $service "sonarr" }}
                        {{ $sortByField = "airDateUtc" }}
                      {{ else }}
                        {{ $sortByField = "releaseDate" }}
                      {{ end }}
                    {{ else if eq $type "recent" }}
                      {{ $sortByField = "date" }}
                    {{ else }}
                      {{ if eq $service "sonarr" }}
                        {{ $sortByField = "airDateUtc" }}
                      {{ else }}
                        {{ $sortByField = "releaseDate" }}
                      {{ end }}
                    {{ end }}
              
                    {{ range $data.JSON.Array $array | sortByTime $sortByField "rfc3339" $sortTime }}
                      
                      {{ if eq $service "sonarr" }}
                        {{ $itemDate = .String "airDateUtc" | parseTime "RFC3339" }}
                        {{ $itemDate = $itemDate.In now.Location | formatTime "2006-01-02T15:04:05" }}
                        {{ $isAvailable = true }}
                      {{ else if eq $service "radarr"}}
                        {{ $isAvailable = .Bool "isAvailable" }}
                        {{ $itemDate = .String "releaseDate" }}
                      {{ else if eq $service "lidarr"}}
                        {{ $itemDate = .String "releaseDate" }}
                        {{ $isAvailable = true }}
                      {{ end }}
              
                      {{ if or (eq $type "upcoming") (eq $type "recent") (and (or (and (gt $itemDate $negInterval) ((lt $itemDate $now ))) (eq $intervalH 0))  $isAvailable) }}
                        {{ $itemDisplayed = true }}
                        {{ $title := "" }}
                        {{ $subtitle := "" }}
                        {{ $coverUrl := "" }}
                        {{ $status := "" }}
                        {{ $coverBase := "" }}
                        {{ $height := "" }}
                        {{ $width := "" }}
                        {{ $popoverTitle := "" }}
                        {{ $popoverSubtitle := "" }}
                        {{ $popoverSummary := "" }}
                        {{ $summary := "" }}
                        {{ $link := "" }}
                        {{ $grabbed := false }}
                        {{ $date := now }}
                        {{ $datetype := "" }}
                        {{ $seString := "" }}
                        {{ $genres := "" }}
                        {{ $buttonJustify := "left" }}
              
                
                        {{ if eq $service "sonarr" }}
                          {{ $series := "" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                            {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "seriesId") $key }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                            {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "seriesId") }}
                          {{ end }}
                          {{ $title = .String "series.title" }}
                          {{ $link = printf "%s/series/%s#" $url (.String "series.titleSlug") }}
                          {{ $series = .Get "series" }}
                          {{ $genres = $series.Get "genres" }}
                        
                          {{ if eq $type "recent" }}
                            {{ $date = .String "date" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "episode.title" }}
                            {{ $summary = .String "episode.overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "episode.seasonNumber") (.Int "episode.episodeNumber") }}
                            {{ $datetype = "Downloaded" }}
                    
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "episode.title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "episode.overview" }}
                              {{ if .Bool "episode.hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                
                          {{ else if eq $type "missing" }}
                            {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "title" }}
                            {{ $summary = .String "overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                            {{ $datetype = "Aired" }}
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "overview" }}
                              {{ if .Bool "episode.hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                          {{ else if eq $type "upcoming" }}
                            {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "title" }}
                            {{ $summary = .String "overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                            {{ $datetype = "Airs" }}
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "overview" }}
                              {{ if .Bool "hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                          {{ end }}
                    
                    
                        {{ else if eq $service "radarr" }}
                          {{ $movie := "" }}
                          {{ $status = .String "status" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                          {{ end }}
                          {{ if eq $status "announced"}}
                            {{ if ne (.String "inCinemas") "" }}
                              {{ $date = (.String "inCinemas" | parseTime "RFC3339") }}
                              {{ $datetype = "In Cinemas" }}
                            {{ else }}
                              {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                              {{ $datetype = "Releases" }}
                            {{ end }}
                          {{ else if eq $status "inCinemas"}}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $datetype = "Releases" }}
                          {{ else if eq $status "released"}}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $datetype = "Released" }}
                          {{ end }}
              
                          {{ if eq $type "recent" }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "movie.id") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "movie.id") }}
                            {{ end }}
                            {{ $datetype = "Downloaded" }}
                            {{ $date = (.String "date" | parseTime "RFC3339") }}
                            {{ $title = .String "movie.title" }}
                            {{ $subtitle = "" }}
                            {{ $summary = .String "movie.overview" }}
                            {{ $popoverTitle = .String "movie.title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "movie.overview" }}
                            {{ $link = printf "%s/movie/%s#" $url (.String "movie.titleSlug") }}
                            {{ $movie = .Get "movie" }}
                            {{ $genres = $movie.Get "genres" }}
                            {{ if and $showGrabbed (gt (.Int "movie.movieFileId") 0) }}
                              {{ $grabbed = true }}
                            {{ end }}
                          {{ else }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "id") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "id") }}
                            {{ end }}
                            {{ $title = .String "title" }}
                            {{ $subtitle = "" }}
                            {{ $summary = .String "overview" }}
                            {{ $link = printf "%s/movie/%s#" $url (.String "titleSlug") }}
                            {{ $popoverTitle = .String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "overview" }}
                            {{ $genres = .Get "genres" }}
                            {{ if eq $type "missing" }}
                              {{ if and $showGrabbed (.Bool "movie.hasFile") }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ if and $showGrabbed (.Bool "hasFile") }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ end }}
                          {{ end }}
              
                    
                        {{ else if eq $service "lidarr" }}
                          {{ $artist := "" }}
                          {{ $album := "" }}
                          {{ $albumId := "" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v1/mediacover" $apiBaseUrl }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                          {{ end }}
              
                          {{ if eq $type "recent" }}
                            {{ $album = .Get "album" }}
                            {{ $artist = $album.Get "artist" }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase (.String "albumId") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase (.String "albumId") }}
                            {{ end }}
                            {{ $grabbed = true }}
                            {{ $title = $album.String "title" }}
                            {{ $date = (.String "date" | parseTime "RFC3339") }}
                            {{ $datetype = "Downloaded" }}
                            {{ $subtitle = $artist.String "artistName" }}
                            {{ $genres = $artist.Get "genres" }}
                            {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                            {{ $summary = $album.String "overview" }}
                            {{ $popoverTitle = $album.String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = $artist.String "overview" }}
              
                          {{ else }}
                            {{ $artist = .Get "artist" }}
                            {{ $album = .Get "album" }}
                            {{ if eq $type "missing" }}
                              {{ $datetype = "Released" }}
                            {{ else }}
                              {{ $datetype = "Releases" }}
                            {{ end }}
                            {{ range .Array "releases" }}
                              {{ $albumId = .String "albumId" }}
                              {{ break }}
                            {{ end }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase $albumId $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase $albumId }}
                            {{ end }}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $title = .String "title" }}
                            {{ $subtitle = $artist.String "artistName" }}
                            {{ $summary = $album.String "overview" }}
                            {{ $genres = $artist.Get "genres" }}
                            {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                            {{ $popoverTitle = .String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "artist.overview" }}
                          {{ end }}
                        {{ end }}
                    
                        {{ if eq $size "small" }}
                          {{ $buttonJustify = "right" }}
                          {{ $height = "9rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "9rem" }}
                          {{ else }}
                            {{ $width = "6rem" }}
                          {{ end }}
                        {{ else if eq $size "medium" }}
                          {{ $height = "12rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "12rem" }}
                          {{ else }}
                            {{ $width = "8rem" }}
                          {{ end }}
                        {{ else if eq $size "large" }} 
                          {{ $height = "15rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "15rem" }}
                          {{ else }}
                            {{ $width = "10rem" }}
                          {{ end }}
                        {{ else if eq $size "huge" }} 
                          {{ $height = "18rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "18rem" }}
                          {{ else }}
                            {{ $width = "12rem" }}
                          {{ end }}
                        {{ end }}
                
                        <li style="position: relative;">
                          <div class="flex gap-10 items-start thumbnail-container thumbnail-parent">
                            <div>
                              <div data-popover-type="html" data-popover-position="above" data-popover-show-delay="500" style="width: {{ $width  }}; height: {{ $height }}; align-content: center;">
                                <div data-popover-html>
                                  <div style="margin: 5px;">
                                    <strong class="size-h4 color-primary" title="{{ $popoverTitle }}">{{ $popoverTitle }}</strong>
                                    <div class="size-h4 text-truncate text-very-compact color-subdue" title="{{ $popoverSubtitle }}">{{ $popoverSubtitle }}</div>
                                    <p class="margin-top-20" style="overflow-y: auto; text-align: justify; max-height: 20rem;">
                                      {{ if ne $popoverSummary "" }}
                                        {{ $popoverSummary }}
                                      {{ else }}
                                        TBA
                                      {{ end }}
                                    </p>
                                  {{ if gt (len ($genres.Array "")) 0 }}
                                    <ul class="attachments margin-top-20">
                                      {{ range $genres.Array "" }}
                                        <li>{{ .String "" }}</li>
                                      {{ end }}
                                    </ul>
                                    {{ end }}
                                  </div>
                                </div>
                                <img class="thumbnail" src="{{ $coverUrl }}" alt="Cover for {{ .String "title" }}" loading="lazy" style="width: 100%; height: 100%; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); object-fit: cover; border-radius: 0.5rem;">
                              </div>
                          </div>
                            <div class="shrink min-width-0" style="height: 9rem; position: relative; padding-top: 5px; padding-right: 5px;">
                              <strong class="size-h4 block text-truncate color-primary" title="{{ $title }}">{{ $title }}</strong>
                              <div class="text-truncate text-very-compact" title="{{ $subtitle }}">{{ $subtitle }}</div>
                              <div class="text-very-compact text-truncate">
                                {{ if eq $service "sonarr" }}
                                  <div>{{ $seString }} - {{ $datetype }} {{ $date.Format "1/2 03:04PM" }}</div>
                                {{ else }}
                                  <span>{{ $datetype }} {{ $date.Format "1/2" }}</span>
                                {{ end }}
                              </div>
                
                              {{ if $showGrabbed }}
                                {{ if eq $buttonJustify "right" }}
                                  </div>
                                  <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                                    style="position: absolute; bottom: 1rem; right: 1rem;
                                      {{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                      font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                                  {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                                  </a>
                                {{ else }}
                                  <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                                    style="{{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                      font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                                  {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                                  </a>
                                  </div>
                                {{ end }}
                              {{ else }}
                                <div class="{{ if eq $size "small" }}text-truncate{{ if eq $service "radarr" }} margin-top-5{{ end }}{{ else }}text-truncate-2-lines margin-top-5{{ end }}">
                                  {{ $summary }}
                                </div>
                              {{ end }}
                          </div>
                        </li>
                      {{ end }}
                    {{ end }}
                    {{ if not $itemDisplayed }}
                      <li>No items found.</li>
                    {{ end }}
                  </ul>
                {{ end }}

            - type: custom-api
              title: Movie Releases
              title-url: ${RADARR_URL}
              cache: 30m
              options:
                service: radarr          # sonarr, radarr, or lidarr
                type: upcoming           # upcoming, recent, or missing
                size: small             # small, medium, large, or huge
                collapse-after: 2
                show-grabbed: false
                interval: 60             # optional, days
                sort-time: asc          # optional, asc or desc (default)
                #cover-proxy: "https://proxy.example.com/radarrcover" # optional
                api-base-url: ${RADARR_URL}
                key: ${RADARR_API_KEY}
              template: |
                {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}
                {{ $showGrabbed := .Options.BoolOr "show-grabbed" false }}
                {{ $sortTime := .Options.StringOr "sort-time" "desc" }}
                {{ $coverProxy := .Options.StringOr "cover-proxy" "" }}
                {{ $size := .Options.StringOr "size" "medium" }}
                {{ $service := .Options.StringOr "service" "" }}
                {{ $type := .Options.StringOr "type" "" }}
                {{ $intervalH := .Options.IntOr "interval" 0 | mul 24 }}

                {{ $now := now | formatTime "2006-01-02T15:04:05" }}
                {{ $posInterval := (offsetNow (printf "+%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}
                {{ $negInterval := (offsetNow (printf "-%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}

                {{ $apiBaseUrl := .Options.StringOr "api-base-url" "" }}
                {{ $key := .Options.StringOr "key" "" }}
                {{ $url := .Options.StringOr "url" $apiBaseUrl }}

                {{ if or (and (ne $service "sonarr") (ne $service "radarr") (ne $service "lidarr"))
                        (and (ne $type "upcoming") (ne $type "recent") (ne $type "missing")) 
                        (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
                  <div class="widget-error-header">
                      <div class="color-negative size-h3">ERROR</div>
                      <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                      </svg>
                    </div>
                    <p class="break-all">
                      Some options are not set or malformed
                        <table style="border-spacing: 1rem;">
                          <tr><td>service</td><td>{{ $service }}</td><td>must be sonarr, radarr, or lidarr</td></tr>
                          <tr><td>type</td><td>{{ $type }}</td><td>must be upcoming, recent, or missing</td></tr>
                          <tr><td>api-base-url</td><td>{{ $apiBaseUrl }}</td><td>should include http(s):// and port if needed</td></tr>
                          <tr><td>key</td><td>{{ $key }}</td><td></td></tr>
                        </table> 
                    </p>
                {{ else }}
                  {{ $requestUrl := "" }}
              
                  {{ if eq $service "sonarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v3/history/since?includeSeries=true&includeEpisode=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50&includeSeries=true" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v3/calendar?includeSeries=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                    
                  {{ else if eq $service "radarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v3/history/since?includeMovie=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v3/calendar?start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                    
                  {{ else if eq $service "lidarr" }}
                    {{ if eq $type "recent" }}
                      {{ $requestUrl = printf "%s/api/v1/history/since?includeArtist=true&includeAlbum=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
                    {{ else if eq $type "missing" }}
                      {{ $requestUrl = printf "%s/api/v1/wanted/missing?page=1&pageSize=50&includeArtist=true" $apiBaseUrl }}
                    {{ else if eq $type "upcoming" }}
                      {{ $requestUrl = printf "%s/api/v1/calendar?includeArtist=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
                    {{ end }}
                  {{ end }}
              
                  {{ $data := newRequest $requestUrl
                    | withHeader "Accept" "application/json"
                    | withHeader "X-Api-Key" $key
                    | getResponse }}
              
                  <ul class="list list-gap-14 collapsible-container single-line-titles" data-collapse-after="{{ $collapseAfter }}">
                    {{ $array := "" }}
                    {{ $sortByField := "" }}
                    {{ $itemDisplayed := false }}
                    {{ $itemDate := "" }}
                    {{ $isAvailable := false }}
              
                    {{ if eq $type "missing" }}
                      {{ $array = "records" }}
                      {{ if eq $service "sonarr" }}
                        {{ $sortByField = "airDateUtc" }}
                      {{ else }}
                        {{ $sortByField = "releaseDate" }}
                      {{ end }}
                    {{ else if eq $type "recent" }}
                      {{ $sortByField = "date" }}
                    {{ else }}
                      {{ if eq $service "sonarr" }}
                        {{ $sortByField = "airDateUtc" }}
                      {{ else }}
                        {{ $sortByField = "releaseDate" }}
                      {{ end }}
                    {{ end }}
              
                    {{ range $data.JSON.Array $array | sortByTime $sortByField "rfc3339" $sortTime }}
                      
                      {{ if eq $service "sonarr" }}
                        {{ $itemDate = .String "airDateUtc" | parseTime "RFC3339" }}
                        {{ $itemDate = $itemDate.In now.Location | formatTime "2006-01-02T15:04:05" }}
                        {{ $isAvailable = true }}
                      {{ else if eq $service "radarr"}}
                        {{ $isAvailable = .Bool "isAvailable" }}
                        {{ $itemDate = .String "releaseDate" }}
                      {{ else if eq $service "lidarr"}}
                        {{ $itemDate = .String "releaseDate" }}
                        {{ $isAvailable = true }}
                      {{ end }}
              
                      {{ if or (eq $type "upcoming") (eq $type "recent") (and (or (and (gt $itemDate $negInterval) ((lt $itemDate $now ))) (eq $intervalH 0))  $isAvailable) }}
                        {{ $itemDisplayed = true }}
                        {{ $title := "" }}
                        {{ $subtitle := "" }}
                        {{ $coverUrl := "" }}
                        {{ $status := "" }}
                        {{ $coverBase := "" }}
                        {{ $height := "" }}
                        {{ $width := "" }}
                        {{ $popoverTitle := "" }}
                        {{ $popoverSubtitle := "" }}
                        {{ $popoverSummary := "" }}
                        {{ $summary := "" }}
                        {{ $link := "" }}
                        {{ $grabbed := false }}
                        {{ $date := now }}
                        {{ $datetype := "" }}
                        {{ $seString := "" }}
                        {{ $genres := "" }}
                        {{ $buttonJustify := "left" }}
              
                
                        {{ if eq $service "sonarr" }}
                          {{ $series := "" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                            {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "seriesId") $key }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                            {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "seriesId") }}
                          {{ end }}
                          {{ $title = .String "series.title" }}
                          {{ $link = printf "%s/series/%s#" $url (.String "series.titleSlug") }}
                          {{ $series = .Get "series" }}
                          {{ $genres = $series.Get "genres" }}
                        
                          {{ if eq $type "recent" }}
                            {{ $date = .String "date" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "episode.title" }}
                            {{ $summary = .String "episode.overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "episode.seasonNumber") (.Int "episode.episodeNumber") }}
                            {{ $datetype = "Downloaded" }}
                    
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "episode.title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "episode.overview" }}
                              {{ if .Bool "episode.hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                
                          {{ else if eq $type "missing" }}
                            {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "title" }}
                            {{ $summary = .String "overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                            {{ $datetype = "Aired" }}
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "overview" }}
                              {{ if .Bool "episode.hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                          {{ else if eq $type "upcoming" }}
                            {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                            {{ $date = $date.In now.Location }}
                            {{ $subtitle = .String "title" }}
                            {{ $summary = .String "overview" }}
                            {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                            {{ $datetype = "Airs" }}
                            {{ if $showGrabbed }}
                              {{ $popoverTitle = .String "title" }}
                              {{ $popoverSubtitle = $seString }}
                              {{ $popoverSummary = .String "overview" }}
                              {{ if .Bool "hasFile" }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ $popoverTitle = .String "series.title" }}
                              {{ $popoverSummary = .String "series.overview" }}
                            {{ end }}
                          {{ end }}
                    
                    
                        {{ else if eq $service "radarr" }}
                          {{ $movie := "" }}
                          {{ $status = .String "status" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                          {{ end }}
                          {{ if eq $status "announced"}}
                            {{ if ne (.String "inCinemas") "" }}
                              {{ $date = (.String "inCinemas" | parseTime "RFC3339") }}
                              {{ $datetype = "In Cinemas" }}
                            {{ else }}
                              {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                              {{ $datetype = "Releases" }}
                            {{ end }}
                          {{ else if eq $status "inCinemas"}}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $datetype = "Releases" }}
                          {{ else if eq $status "released"}}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $datetype = "Released" }}
                          {{ end }}
              
                          {{ if eq $type "recent" }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "movie.id") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "movie.id") }}
                            {{ end }}
                            {{ $datetype = "Downloaded" }}
                            {{ $date = (.String "date" | parseTime "RFC3339") }}
                            {{ $title = .String "movie.title" }}
                            {{ $subtitle = "" }}
                            {{ $summary = .String "movie.overview" }}
                            {{ $popoverTitle = .String "movie.title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "movie.overview" }}
                            {{ $link = printf "%s/movie/%s#" $url (.String "movie.titleSlug") }}
                            {{ $movie = .Get "movie" }}
                            {{ $genres = $movie.Get "genres" }}
                            {{ if and $showGrabbed (gt (.Int "movie.movieFileId") 0) }}
                              {{ $grabbed = true }}
                            {{ end }}
                          {{ else }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "id") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "id") }}
                            {{ end }}
                            {{ $title = .String "title" }}
                            {{ $subtitle = "" }}
                            {{ $summary = .String "overview" }}
                            {{ $link = printf "%s/movie/%s#" $url (.String "titleSlug") }}
                            {{ $popoverTitle = .String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "overview" }}
                            {{ $genres = .Get "genres" }}
                            {{ if eq $type "missing" }}
                              {{ if and $showGrabbed (.Bool "movie.hasFile") }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ else }}
                              {{ if and $showGrabbed (.Bool "hasFile") }}
                                {{ $grabbed = true }}
                              {{ end }}
                            {{ end }}
                          {{ end }}
              
                    
                        {{ else if eq $service "lidarr" }}
                          {{ $artist := "" }}
                          {{ $album := "" }}
                          {{ $albumId := "" }}
                          {{ if eq $coverProxy "" }}
                            {{ $coverBase = printf "%s/api/v1/mediacover" $apiBaseUrl }}
                          {{ else }}
                            {{ $coverBase = $coverProxy }}
                          {{ end }}
              
                          {{ if eq $type "recent" }}
                            {{ $album = .Get "album" }}
                            {{ $artist = $album.Get "artist" }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase (.String "albumId") $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase (.String "albumId") }}
                            {{ end }}
                            {{ $grabbed = true }}
                            {{ $title = $album.String "title" }}
                            {{ $date = (.String "date" | parseTime "RFC3339") }}
                            {{ $datetype = "Downloaded" }}
                            {{ $subtitle = $artist.String "artistName" }}
                            {{ $genres = $artist.Get "genres" }}
                            {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                            {{ $summary = $album.String "overview" }}
                            {{ $popoverTitle = $album.String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = $artist.String "overview" }}
              
                          {{ else }}
                            {{ $artist = .Get "artist" }}
                            {{ $album = .Get "album" }}
                            {{ if eq $type "missing" }}
                              {{ $datetype = "Released" }}
                            {{ else }}
                              {{ $datetype = "Releases" }}
                            {{ end }}
                            {{ range .Array "releases" }}
                              {{ $albumId = .String "albumId" }}
                              {{ break }}
                            {{ end }}
                            {{ if eq $coverProxy "" }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase $albumId $key }}
                            {{ else }}
                              {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase $albumId }}
                            {{ end }}
                            {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                            {{ $title = .String "title" }}
                            {{ $subtitle = $artist.String "artistName" }}
                            {{ $summary = $album.String "overview" }}
                            {{ $genres = $artist.Get "genres" }}
                            {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                            {{ $popoverTitle = .String "title" }}
                            {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                            {{ $popoverSummary = .String "artist.overview" }}
                          {{ end }}
                        {{ end }}
                    
                        {{ if eq $size "small" }}
                          {{ $buttonJustify = "right" }}
                          {{ $height = "9rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "9rem" }}
                          {{ else }}
                            {{ $width = "6rem" }}
                          {{ end }}
                        {{ else if eq $size "medium" }}
                          {{ $height = "12rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "12rem" }}
                          {{ else }}
                            {{ $width = "8rem" }}
                          {{ end }}
                        {{ else if eq $size "large" }} 
                          {{ $height = "15rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "15rem" }}
                          {{ else }}
                            {{ $width = "10rem" }}
                          {{ end }}
                        {{ else if eq $size "huge" }} 
                          {{ $height = "18rem" }}
                          {{ if eq $service "lidarr" }}
                            {{ $width = "18rem" }}
                          {{ else }}
                            {{ $width = "12rem" }}
                          {{ end }}
                        {{ end }}
                
                        <li style="position: relative;">
                          <div class="flex gap-10 items-start thumbnail-container thumbnail-parent">
                            <div>
                              <div data-popover-type="html" data-popover-position="above" data-popover-show-delay="500" style="width: {{ $width  }}; height: {{ $height }}; align-content: center;">
                                <div data-popover-html>
                                  <div style="margin: 5px;">
                                    <strong class="size-h4 color-primary" title="{{ $popoverTitle }}">{{ $popoverTitle }}</strong>
                                    <div class="size-h4 text-truncate text-very-compact color-subdue" title="{{ $popoverSubtitle }}">{{ $popoverSubtitle }}</div>
                                    <p class="margin-top-20" style="overflow-y: auto; text-align: justify; max-height: 20rem;">
                                      {{ if ne $popoverSummary "" }}
                                        {{ $popoverSummary }}
                                      {{ else }}
                                        TBA
                                      {{ end }}
                                    </p>
                                  {{ if gt (len ($genres.Array "")) 0 }}
                                    <ul class="attachments margin-top-20">
                                      {{ range $genres.Array "" }}
                                        <li>{{ .String "" }}</li>
                                      {{ end }}
                                    </ul>
                                    {{ end }}
                                  </div>
                                </div>
                                <img class="thumbnail" src="{{ $coverUrl }}" alt="Cover for {{ .String "title" }}" loading="lazy" style="width: 100%; height: 100%; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); object-fit: cover; border-radius: 0.5rem;">
                              </div>
                          </div>
                            <div class="shrink min-width-0" style="height: 9rem; position: relative; padding-top: 5px; padding-right: 5px;">
                              <strong class="size-h4 block text-truncate color-primary" title="{{ $title }}">{{ $title }}</strong>
                              <div class="text-truncate text-very-compact" title="{{ $subtitle }}">{{ $subtitle }}</div>
                              <div class="text-very-compact text-truncate">
                                {{ if eq $service "sonarr" }}
                                  <div>{{ $seString }} - {{ $datetype }} {{ $date.Format "1/2 03:04PM" }}</div>
                                {{ else }}
                                  <span>{{ $datetype }} {{ $date.Format "1/2" }}</span>
                                {{ end }}
                              </div>
                
                              {{ if $showGrabbed }}
                                {{ if eq $buttonJustify "right" }}
                                  </div>
                                  <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                                    style="position: absolute; bottom: 1rem; right: 1rem;
                                      {{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                      font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                                  {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                                  </a>
                                {{ else }}
                                  <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                                    style="{{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                      font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                                  {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                                  </a>
                                  </div>
                                {{ end }}
                              {{ else }}
                                <div class="{{ if eq $size "small" }}text-truncate{{ if eq $service "radarr" }} margin-top-5{{ end }}{{ else }}text-truncate-2-lines margin-top-5{{ end }}">
                                  {{ $summary }}
                                </div>
                              {{ end }}
                          </div>
                        </li>
                      {{ end }}
                    {{ end }}
                    {{ if not $itemDisplayed }}
                      <li>No items found.</li>
                    {{ end }}
                  </ul>
                {{ end }}

    - size: small
      widgets:

        - type: custom-api
          title: "Jellyfin Stats"
          base-url: ${JELLYFIN_URL}
          options:
            url: ${JELLYFIN_URL}
            key: ${JELLYFIN_API_KEY}

          template: |
            {{ $url := .Options.StringOr "url" "" }}
            {{ $key := .Options.StringOr "key" "" }}

            {{- if or (eq $url "") (eq $key "") -}}
            
              <p>Error: The URL or API Key was not configured in the widget options.</p>
              
            {{- else -}}

              {{- $requestUrl := printf "%s/emby/Items/Counts?api_key=%s" $url $key -}}
              {{- $jellyfinData := newRequest $requestUrl | getResponse -}}

              {{- if eq $jellyfinData.Response.StatusCode 200 -}}
                <div class="flex flex-column gap-5">
                  <div class="flex justify-between text-center">
                    
                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "MovieCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">Movies</div>
                    </div>

                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SeriesCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">TV Shows</div>
                    </div>

                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "EpisodeCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">Episodes</div>
                    </div>

                  </div>
                </div>
              {{- else -}}
                <p>Failed: {{ $jellyfinData.Response.Status }}</p>
              {{- end -}}
            {{- end -}}

        - type: custom-api
          title: Immich stats
          cache: 1d
          url: ${IMMICH_URL}/api/server/statistics
          headers:
            x-api-key: ${IMMICH_API_KEY}
            Accept: application/json
          template: |
            <div class="flex justify-evenly text-center">
              <div>
                  <div class="color-highlight size-h3">{{ .JSON.Int "photos" | formatNumber }}</div>
                  <div class="size-h6">PHOTOS</div>
              </div>
              <div>
                  <div class="color-highlight size-h3">{{ .JSON.Int "videos" | formatNumber }}</div>
                  <div class="size-h6">VIDEOS</div>
              </div>
            </div>

        - type: releases
          token: ${GITHUB_TOKEN}
          title: Media App Updates
          repositories:
            - jellyfin/jellyfin
            - immich-app/immich
            - Sonarr/Sonarr
            - Radarr/Radarr
            - Readarr/Readarr
            - Prowlarr/Prowlarr
            - transmission/transmission
            - dockerhub:thrnz/docker-wireguard-pia
            - FlareSolverr/FlareSolverr
          show-source-icon: true
          limit: 25
          collapse-after: 5
          cache: 3h
